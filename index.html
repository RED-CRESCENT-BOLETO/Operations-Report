<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>EMS TOTAL SYSTEM - V11 FIXED</title>
    <style>
        :root { --red: #b32633; --blue: #1e1e1e; --gold: #ffd700; --purple: #6a1b9a; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: #000 url('https://i.top4top.io/p_3592jzcr01.jpg') no-repeat center center fixed; background-size: cover; color: white; margin: 0; padding: 0; overflow-x: hidden; }
        .overlay { background: rgba(0,0,0,0.94); min-height: 100vh; padding: 15px; box-sizing: border-box; }
        
        /* Navigation Tabs */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .tab-btn { padding: 12px 60px; border-radius: 8px; border: 1px solid #444; background: #1a1a1a; color: white; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .tab-btn.active-ls { background: var(--red); border-color: white; box-shadow: 0 0 10px var(--red); }
        .tab-btn.active-sb { background: #444; border-color: white; box-shadow: 0 0 10px #666; }

        .top-line { border-top: 2px solid var(--red); display: flex; justify-content: space-between; padding: 8px 20px; font-size: 14px; background: rgba(0,0,0,0.8); margin-bottom: 15px; }
        
        /* Central Control Panel */
        .control-panel { background: rgba(20,20,20,0.8); border: 1px solid #333; border-radius: 15px; padding: 20px; margin: 0 auto 25px; max-width: 900px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .action-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .btn-green { background: #27ae60; color: white; padding: 8px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-red { background: var(--red); color: white; padding: 8px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        
        .letters-row { display: flex; justify-content: center; gap: 6px; margin-bottom: 15px; flex-wrap: wrap; }
        .let-btn { width: 42px; height: 42px; background: #222; border: 1px solid #555; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .let-btn.active { background: var(--red); border-color: white; transform: scale(1.1); }

        .input-row { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 15px; }
        .main-input { background: #000; border: 2px solid #444; color: white; font-size: 45px; width: 160px; text-align: center; border-radius: 10px; padding: 5px; outline: none; }
        .main-input:focus { border-color: var(--gold); }
        
        .manual-btns { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
        .m-btn { background: #111; border: 1px solid #444; color: #ddd; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .m-btn:hover { background: #222; border-color: var(--gold); }

        /* Grid Layout (Matches Image) */
        .grid-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 100px; }
        .row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        
        .box { width: 135px; background: rgba(0,0,0,0.8); border: 1px solid #222; border-radius: 6px; overflow: hidden; min-height: 90px; }
        .box-header { padding: 6px; text-align: center; font-size: 11px; font-weight: bold; }
        .box-body { padding: 6px; display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; align-content: flex-start; }
        
        .bg-red { background: var(--red); color: white; }
        .bg-purple { background: var(--purple); color: white; }
        .bg-white { background: var(--white); color: black; }
        
        .unit-tag { background: #0a0a0a; border: 1px solid #333; padding: 4px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; position: relative; cursor: pointer; color: white; }
        .unit-tag:hover { background: #1a1a1a; border-color: #666; }
        .tag-menu { display: none; position: absolute; bottom: 100%; left: 0; background: #222; border: 1px solid #555; z-index: 1000; width: 85px; border-radius: 4px; }
        .unit-tag:hover .tag-menu { display: block; }
        .tag-menu div { padding: 6px; border-bottom: 1px solid #333; font-size: 10px; text-align: center; color: white; }
        .tag-menu div:hover { background: #444; }

        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #000; padding: 15px; border-top: 2px solid #333; text-align: center; z-index: 2000; }
        .copy-btn { background: #27ae60; color: white; border: none; padding: 12px 100px; border-radius: 8px; font-weight: bold; font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); }
    </style>
</head>
<body>

<div class="overlay">
    <div class="tabs">
        <button id="sbBtn" class="tab-btn" onclick="switchSys('SB')">Ø³Ø§Ù†Ø¯ÙŠ ÙˆØ¨ÙˆÙ„ÙŠØªÙˆ (SB)</button>
        <button id="lsBtn" class="tab-btn active-ls" onclick="switchSys('LS')">Ù„ÙˆØ³ Ø³Ø§Ù†ØªÙˆØ³ (LS)</button>
    </div>

    <div class="top-line">
        <div id="clock">00:00:00</div>
        <div>ØªÙ‚Ø±ÙŠØ± <span id="cityTitle">LS</span> Ø±Ù‚Ù…: <span id="repNum" onclick="changeRepNum()" style="color:var(--gold); cursor:pointer;">1</span></div>
    </div>

    <div class="control-panel">
        <div class="action-row">
            <button class="btn-green" onclick="shuffleField()">ğŸ”„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Ù…ÙŠØ¯Ø§Ù†ÙŠ)</button>
            <button class="btn-red" id="resetBtn" onclick="resetCurrentCity()">âš ï¸ ØªØµÙÙŠØ± LS</button>
        </div>
        
        <div id="letters" class="letters-row"></div>

        <div class="input-row">
            <button class="m-btn" onclick="undo()">ØªØ±Ø§Ø¬Ø¹ â†©ï¸</button>
            <input type="text" id="mainInput" class="main-input" placeholder="000" maxlength="4" oninput="handleInput(this)">
            <button class="m-btn" id="digitBtn" onclick="toggleDigits()">3 Ø£Ø±Ù‚Ø§Ù…</button>
        </div>

        <div class="manual-btns">
            <button class="m-btn" onclick="addManually('Ø¯Ø¹Ù…')">+ Ø¯Ø¹Ù…</button>
            <button class="m-btn" onclick="addManually('Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡')">+ Ù…ÙŠÙ†Ø§Ø¡</button>
            <button class="m-btn" onclick="addManually('ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°')">+ Ø¨Ø­Ø«</button>
            <button class="m-btn" onclick="addManually('Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ')">+ Ù…Ø´Ø±Ù</button>
            <button class="m-btn" onclick="addManually('Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…')">+ Ø§Ø´Ø±Ø§Ù</button>
            <button class="m-btn" onclick="addManually('Ø§Ù„Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©')">+ Ù‚ÙŠØ§Ø¯Ø©</button>
        </div>
    </div>

    <div class="grid-container">
        <div class="row" id="row1"></div>
        <div class="row" id="row2"></div>
        <div class="row" id="row3"></div>
    </div>
</div>

<div class="footer">
    <button class="copy-btn" onclick="copyReport()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
</div>

<script>
    let currentCity = 'LS';
    let currentLet = 'E';
    let digits = 3;
    let history = [];

    const structure = {
        LS: {
            row1: ["Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 5", "ÙØ±Ø³Ø§Ù†"],
            row2: ["Ø§Ù„Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ", "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "Ø¯Ø¹Ù…"],
            row3: ["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"]
        },
        SB: {
            row1: ["Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ø³ÙŠÙ†", "Ø³ÙŠÙ† 1", "Ø¨Ø§Ø¡", "Ø¨Ø§Ø¡ 1", "Ø¬ÙŠÙ… 1", "Ø¬ÙŠÙ… 2"],
            row2: ["Ø§Ù„Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ", "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "Ø¯Ø¹Ù…"],
            row3: ["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"]
        }
    };

    let data = JSON.parse(localStorage.getItem('EMS_PRO_DATABASE')) || { LS: {}, SB: {}, repLS: 1, repSB: 1 };

    function init() {
        ['LS','SB'].forEach(c => {
            if(!data[c]) data[c] = {};
            [...structure[c].row1, ...structure[c].row2, ...structure[c].row3].forEach(k => {
                if(!data[c][k]) data[c][k] = [];
            });
        });
        render();
    }

    function render() {
        const city = currentCity;
        document.getElementById('cityTitle').innerText = city;
        document.getElementById('repNum').innerText = (city === 'LS' ? data.repLS : data.repSB);
        document.getElementById('resetBtn').innerText = `âš ï¸ ØªØµÙÙŠØ± ${city}`;

        ['row1','row2','row3'].forEach(rId => {
            const container = document.getElementById(rId);
            container.innerHTML = structure[city][rId].map(k => {
                let colorClass = 'bg-red';
                if(['Ø§Ù„Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©','Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…','Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ'].includes(k)) colorClass = 'bg-purple';
                if(['ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°','Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡','Ø¯Ø¹Ù…'].includes(k)) colorClass = 'bg-white';
                
                let units = data[city][k].map((u, i) => `
                    <div class="unit-tag">${u}
                        <div class="tag-menu">
                            <div onclick="moveOut('${k}',${i})">â¡ï¸ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>
                            <div onclick="editUnit('${k}',${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</div>
                            <div onclick="deleteUnit('${k}',${i})">âŒ Ø­Ø°Ù</div>
                        </div>
                    </div>
                `).join('');
                
                return `<div class="box">
                            <div class="box-header ${colorClass}">${k}</div>
                            <div class="box-body">${units}</div>
                        </div>`;
            }).join('');
        });
        localStorage.setItem('EMS_PRO_DATABASE', JSON.stringify(data));
    }

    function handleInput(el) {
        el.value = el.value.replace(/\D/g,'');
        if(el.value.length >= digits) {
            const code = currentLet + "-" + el.value;
            if(isDuplicate(code)) { alert("Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†!"); el.value = ''; return; }
            
            let target = getAutoTarget();
            data[currentCity][target].push(code);
            history.push({city: currentCity, key: target});
            el.value = ''; 
            render();
        }
    }

    function getAutoTarget() {
        const d = data[currentCity];
        if(d["Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª"].length === 0) return "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª";
        if(d["Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª"].length === 0) return "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª";
        
        if(currentCity === 'LS') {
            let n = d["Ù„Ø§Ù… 2"].length + d["Ù„Ø§Ù… 4"].length + d["Ù„Ø§Ù… 3"].length + d["Ù„Ø§Ù… 1"].length + d["ÙØ±Ø³Ø§Ù†"].length + d["Ù„Ø§Ù… 5"].length;
            const seq = ["Ù„Ø§Ù… 2","Ù„Ø§Ù… 4","Ù„Ø§Ù… 3","Ù„Ø§Ù… 1","ÙØ±Ø³Ø§Ù†","Ù„Ø§Ù… 2","Ù„Ø§Ù… 4","Ù„Ø§Ù… 3","Ù„Ø§Ù… 1","Ù„Ø§Ù… 2","Ù„Ø§Ù… 4","Ù„Ø§Ù… 1","Ù„Ø§Ù… 5"];
            return (n < 13) ? seq[n] : ["Ù„Ø§Ù… 2","Ù„Ø§Ù… 4","Ù„Ø§Ù… 3","Ù„Ø§Ù… 1","Ù„Ø§Ù… 5","ÙØ±Ø³Ø§Ù†"][(n-13)%6];
        } else {
            let n = d["Ø³ÙŠÙ† 1"].length + d["Ø¨Ø§Ø¡ 1"].length + d["Ø³ÙŠÙ†"].length + d["Ø¬ÙŠÙ… 1"].length + d["Ø¨Ø§Ø¡"].length + d["Ø¬ÙŠÙ… 2"].length;
            const seq = ["Ø³ÙŠÙ† 1","Ø¨Ø§Ø¡ 1","Ø³ÙŠÙ†","Ø¬ÙŠÙ… 1","Ø¨Ø§Ø¡","Ø³ÙŠÙ† 1","Ø¨Ø§Ø¡ 1","Ø³ÙŠÙ†","Ø¬ÙŠÙ… 1","Ø¨Ø§Ø¡","Ø³ÙŠÙ† 1","Ø¨Ø§Ø¡ 1","Ø³ÙŠÙ†","Ø¬ÙŠÙ… 1","Ø³ÙŠÙ† 1","Ø³ÙŠÙ†","Ø¨Ø§Ø¡","Ø¨Ø§Ø¡","Ø¬ÙŠÙ… 2","Ø¬ÙŠÙ… 2","Ø¬ÙŠÙ… 2"];
            return (n < 21) ? seq[n] : ["Ø³ÙŠÙ† 1","Ø¨Ø§Ø¡ 1","Ø³ÙŠÙ†","Ø¬ÙŠÙ… 1","Ø¨Ø§Ø¡","Ø¬ÙŠÙ… 2"][(n-21)%6];
        }
    }

    function isDuplicate(code) {
        const exceptions = ["Ø§Ù„Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ"];
        for(let k in data[currentCity]) {
            if(!exceptions.includes(k) && data[currentCity][k].includes(code)) return true;
        }
        return false;
    }

    function addManually(key) {
        let code = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù€ ${key}:`, currentLet + "-");
        if(code) {
            data[currentCity][key].push(code);
            render();
        }
    }

    function switchSys(city) {
        currentCity = city;
        document.getElementById('lsBtn').className = 'tab-btn' + (city==='LS'?' active-ls':'');
        document.getElementById('sbBtn').className = 'tab-btn' + (city==='SB'?' active-sb':'');
        render();
    }

    function toggleDigits() { 
        digits = (digits === 3 ? 4 : 3); 
        document.getElementById('digitBtn').innerText = digits + " Ø£Ø±Ù‚Ø§Ù…"; 
    }

    function moveOut(k, i) { 
        let unit = data[currentCity][k].splice(i, 1)[0];
        data[currentCity]["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"].push(unit);
        if(!structure[currentCity].row2.includes(k)) rebalance();
        render(); 
    }

    function deleteUnit(k, i) { 
        data[currentCity][k].splice(i, 1); 
        if(!structure[currentCity].row2.includes(k)) rebalance();
        render(); 
    }

    function editUnit(k, i) {
        let newVal = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯:", data[currentCity][k][i]);
        if(newVal) { data[currentCity][k][i] = newVal; render(); }
    }

    function undo() {
        if(history.length > 0) {
            let last = history.pop();
            data[last.city][last.key].pop();
            render();
        }
    }

    function rebalance() {
        let city = currentCity;
        let fieldKeys = (city === 'LS') ? ["Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 5", "ÙØ±Ø³Ø§Ù†"] : ["Ø³ÙŠÙ†", "Ø³ÙŠÙ† 1", "Ø¨Ø§Ø¡", "Ø¨Ø§Ø¡ 1", "Ø¬ÙŠÙ… 1", "Ø¬ÙŠÙ… 2"];
        let allUnits = [];
        fieldKeys.forEach(k => { allUnits.push(...data[city][k]); data[city][k] = []; });
        allUnits.forEach(u => {
            let t = getAutoTarget();
            data[city][t].push(u);
        });
    }

    function shuffleField() {
        let city = currentCity;
        let fieldKeys = (city === 'LS') ? ["Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 5", "ÙØ±Ø³Ø§Ù†"] : ["Ø³ÙŠÙ†", "Ø³ÙŠÙ† 1", "Ø¨Ø§Ø¡", "Ø¨Ø§Ø¡ 1", "Ø¬ÙŠÙ… 1", "Ø¬ÙŠÙ… 2"];
        let allUnits = [];
        fieldKeys.forEach(k => { allUnits.push(...data[city][k]); data[city][k] = []; });
        allUnits.sort(() => Math.random() - 0.5);
        allUnits.forEach(u => {
            let t = getAutoTarget();
            data[city][t].push(u);
        });
        render();
    }

    function changeRepNum() {
        let n = prompt("Ø±Ù‚Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
        if(n) {
            if(currentCity === 'LS') data.repLS = n; else data.repSB = n;
            render();
        }
    }

    function resetCurrentCity() {
        if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ${currentCity}ØŸ`)) {
            [...structure[currentCity].row1, ...structure[currentCity].row2, ...structure[currentCity].row3].forEach(k => data[currentCity][k] = []);
            render();
        }
    }

    function copyReport() {
        const city = currentCity;
        const d = data[city];
        const r = (city === 'LS' ? data.repLS : data.repSB);
        let txt = `ØªÙ‚Ø±ÙŠØ± ${city === 'LS' ? 'Ù„ÙˆØ³ Ø³Ø§Ù†ØªÙˆØ³' : 'Ø³Ø§Ù†Ø¯ÙŠ ÙˆØ¨ÙˆÙ„ÙŠØªÙˆ'} Ø±Ù‚Ù… (${r})\n`;
        txt += `Ø§Ù„ÙŠÙˆÙ…: ${new Date().toLocaleDateString('ar-SA')} | Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ar-SA')}\n\n`;
        
        [...structure[city].row1, ...structure[city].row2, ...structure[city].row3].forEach(k => {
            if(d[k].length > 0) {
                txt += `${k}:\n${d[k].join(k.includes("Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª") ? " | " : "\n")}\n\n`;
            }
        });
        
        navigator.clipboard.writeText(txt).then(() => alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­"));
    }

    // Letters Setup
    const lets = ['H','P','G','C','S','M','F','A','E'];
    const lContainer = document.getElementById('letters');
    lets.forEach(l => {
        let b = document.createElement('button'); b.className = 'let-btn' + (l==='E'?' active':''); b.innerText = l;
        b.onclick = () => { 
            currentLet = l; 
            document.querySelectorAll('.let-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
        };
        lContainer.appendChild(b);
    });

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'); }, 1000);
    init();
</script>
</body>
</html>
