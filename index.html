<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <style>
        :root { --red: #b32633; --gold: #ffd700; --bg: #0a0a0a; --glass: rgba(255,255,255,0.1); }
        body { font-family: 'Segoe UI', sans-serif; background: #111 url('https://i.top4top.io/p_3592jzcr01.jpg') no-repeat center center fixed; background-size: cover; color: white; margin: 0; padding: 10px; padding-bottom: 120px; }
        .overlay { background: rgba(0,0,0,0.85); min-height: 100vh; padding: 20px; border-radius: 15px; }
        
        .info-bar { display: flex; justify-content: space-between; align-items: center; background: var(--bg); padding: 15px; border-bottom: 3px solid var(--red); border-radius: 10px; margin-bottom: 20px; }
        #clock { font-size: 22px; color: var(--gold); font-weight: bold; }
        #full-date { font-size: 13px; color: #bbb; }

        .main-controls { background: rgba(0,0,0,0.7); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #333; margin-bottom: 20px; }
        .letter-group { display: flex; justify-content: center; gap: 5px; margin: 15px 0; flex-wrap: wrap; }
        .let-btn { width: 40px; height: 40px; border: 2px solid #444; background: #222; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .let-btn.active { background: var(--red); border-color: white; transform: scale(1.1); }

        .input-area { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; }
        #mainInput { font-size: 35px; width: 150px; text-align: center; background: #000; color: var(--red); border: 2px solid #555; border-radius: 10px; padding: 5px; outline: none; }
        
        .mode-toggle { display: flex; flex-direction: column; align-items: center; background: #1a1a1a; padding: 5px 10px; border-radius: 8px; border: 1px solid #444; }
        .switch { width: 34px; height: 18px; position: relative; display: inline-block; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #444; border-radius: 18px; transition: .4s; }
        .slider:before { content: ""; position: absolute; height: 12px; width: 12px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--gold); }
        input:checked + .slider:before { transform: translateX(16px); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--glass); border: 1px solid #444; border-radius: 10px; display: flex; flex-direction: column; min-height: 100px; }
        .card-header { background: var(--red); padding: 6px; text-align: center; font-weight: bold; font-size: 14px; border-radius: 10px 10px 0 0; }
        .card-body { padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }

        .tag { background: #000; border: 1px solid var(--red); padding: 4px 10px; border-radius: 5px; position: relative; cursor: pointer; font-weight: bold; direction: ltr !important; unicode-bidi: bidi-override; }
        .tag-menu { display: none; position: absolute; top: 100%; right: 0; background: #222; z-index: 100; border: 1px solid #555; width: 110px; border-radius: 5px; direction: rtl; }
        .tag:hover .tag-menu { display: block; }
        .tag-menu div { padding: 8px; font-size: 12px; border-bottom: 1px solid #333; text-align: center; color: white; }

        .btn-ui { padding: 8px 12px; cursor: pointer; border-radius: 5px; background: #222; color: white; border: 1px solid #444; font-weight: bold; }
        .btn-ui.active { background: var(--red); }

        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: #050505; padding: 15px; display: flex; gap: 10px; justify-content: center; border-top: 3px solid var(--red); z-index: 1000; }
        .btn-large { padding: 12px 30px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; border: none; color: white; }

        .modal { display: none; position: fixed; z-index: 2000; inset: 0; background: rgba(0,0,0,0.9); }
        .modal-content { background: #111; margin: 2% auto; padding: 20px; border: 1px solid var(--red); width: 90%; max-width: 500px; border-radius: 10px; }
        #reportText { background: #000; color: #fff; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: 'Consolas', monospace; max-height: 450px; overflow-y: auto; text-align: right; border: 1px solid #333; line-height: 1.8; direction: rtl; }

        h3 { border-right: 4px solid var(--red); padding-right: 10px; margin: 25px 0 10px 0; }
    </style>
</head>
<body>

<div class="overlay">
    <div class="info-bar">
        <div>ØªÙ‚Ø±ÙŠØ±: <button class="btn-ui" id="reportDisplay" onclick="changeReportNum()" style="color:var(--gold)">1</button></div>
        <div class="date-time-box">
            <span id="clock">00:00 Øµ</span>
            <span id="full-date">...</span>
        </div>
        <div style="font-weight: bold; color: var(--red);">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</div>
    </div>

    <div class="main-controls">
        <div style="display:flex; justify-content:center; gap:8px; flex-wrap: wrap; margin-bottom: 10px;">
            <button onclick="setZone('lous')" id="z-lous" class="btn-ui active">Ù„ÙˆØ³ Ø³Ø§Ù†ØªÙˆØ³</button>
            <button onclick="setZone('sandy')" id="z-sandy" class="btn-ui">Ø³Ø§Ù†Ø¯ÙŠ ÙˆØ¨ÙˆÙ„ÙŠØªÙˆ</button>
            <button onclick="rescheduleField()" class="btn-ui" style="background:#1e4d2b">ğŸ”€ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†</button>
            <button onclick="restoreData()" class="btn-ui" style="color:var(--gold); border-color: var(--gold);">ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button onclick="resetAll()" class="btn-ui" style="background:#600">âš ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </div>

        <div class="letter-group">
            <button class="let-btn active" onclick="selLet('E')">E</button>
            <button class="let-btn" onclick="selLet('A')">A</button>
            <button class="let-btn" onclick="selLet('F')">F</button>
            <button class="let-btn" onclick="selLet('M')">M</button>
            <button class="let-btn" onclick="selLet('S')">S</button>
            <button class="let-btn" onclick="selLet('C')">C</button>
            <button class="let-btn" onclick="selLet('G')">G</button>
            <button class="let-btn" onclick="selLet('P')">P</button>
            <button class="let-btn" onclick="selLet('H')">H</button>
        </div>

        <div class="input-area">
            <div class="mode-toggle">
                <span style="font-size:9px">4 Ø£Ø±Ù‚Ø§Ù…</span>
                <input type="checkbox" id="digitMode" onchange="updatePlaceholder()">
            </div>
            <input type="text" id="mainInput" placeholder="Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" inputmode="numeric" oninput="validateAndAutoInput(this)">
            <div class="mode-toggle">
                <span style="font-size:9px">ØªÙˆØ²ÙŠØ¹ ÙØ±Ø¯ÙŠ</span>
                <label class="switch"><input type="checkbox" id="singleMode"><span class="slider"></span></label>
            </div>
        </div>
        
        <div style="display:flex; gap:5px; justify-content:center; flex-wrap: wrap;">
            <button class="btn-ui" onclick="manualAdd('Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©')">â• Ù‚ÙŠØ§Ø¯Ø©</button>
            <button class="btn-ui" onclick="manualAdd('Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…')">â• Ø§Ø´Ø±Ø§Ù</button>
            <button class="btn-ui" onclick="manualAdd('Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ')">â• Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†</button>
            <button class="btn-ui" onclick="manualAdd('Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡')">â• Ù…ÙŠÙ†Ø§Ø¡</button>
            <button class="btn-ui" onclick="manualAdd('ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ù†Ù‚Ø§Ø°')">â• Ø¨Ø­Ø«</button>
            <button class="btn-ui" onclick="manualAdd('Ø¯Ø¹Ù…')">â• Ø¯Ø¹Ù…</button>
        </div>
    </div>

    <h3 id="sectionTitle">Ø§Ù„Ù…ÙŠØ¯Ø§Ù† ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
    <div class="grid" id="mainGrid"></div>
    <h3 style="color:var(--gold)">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù‚ÙŠØ§Ø¯Ø©</h3>
    <div class="grid" id="leadGrid"></div>
    <h3 style="color:#888">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
    <div class="grid" id="exitGrid"></div>
</div>

<div class="bottom-actions">
    <button class="btn-large" style="background:#0056b3;" onclick="openPreview()">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
    <button class="btn-large" style="background:#218838;" onclick="copyDirect()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
</div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; color:var(--red)">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
        <div id="reportText"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-ui" style="flex:1; background:#218838" onclick="copyFromModal()">Ù†Ø³Ø®</button>
            <button class="btn-ui" style="flex:1" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<script>
    let currentZone = 'lous';
    let activeLetter = 'E';
    let data = {};
    let reportNum = localStorage.getItem('ems_rep_num') || "1";

    const configs = {
        lous: {
            main: [{n:"Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", c:1}, {n:"Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", c:1}, {n:"Ù„Ø§Ù… 1", c:3}, {n:"Ù„Ø§Ù… 2", c:3}, {n:"Ù„Ø§Ù… 3", c:2}, {n:"Ù„Ø§Ù… 4", c:3}, {n:"Ù„Ø§Ù… 5", c:1}, {n:"ÙØ±Ø³Ø§Ù†", c:1}],
            order: ["Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ", "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 5", "ÙØ±Ø³Ø§Ù†", "Ø¯Ø¹Ù…", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ù†Ù‚Ø§Ø°", "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"],
            breakOrder: ["Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 5", "ÙØ±Ø³Ø§Ù†"]
        },
        sandy: {
            main: [{n:"Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", c:1}, {n:"Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", c:1}, {n:"Ø³ÙŠÙ† 1", c:4}, {n:"Ø³ÙŠÙ†", c:4}, {n:"Ø¨Ø§Ø¡ 1", c:3}, {n:"Ø¨Ø§Ø¡", c:4}, {n:"Ø¬ÙŠÙ… 1", c:3}, {n:"Ø¬ÙŠÙ… 2", c:3}],
            order: ["Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ", "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ø³ÙŠÙ† 1", "Ø³ÙŠÙ†", "Ø¨Ø§Ø¡ 1", "Ø¨Ø§Ø¡", "Ø¬ÙŠÙ… 1", "Ø¬ÙŠÙ… 2", "Ø¯Ø¹Ù…", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ù†Ù‚Ø§Ø°", "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"],
            breakOrder: ["Ø³ÙŠÙ† 1", "Ø³ÙŠÙ†", "Ø¨Ø§Ø¡ 1", "Ø¨Ø§Ø¡", "Ø¬ÙŠÙ… 1", "Ø¬ÙŠÙ… 2"]
        }
    };

    function init() {
        document.getElementById('reportDisplay').innerText = reportNum;
        let saved = localStorage.getItem('ems_v11_data');
        if(saved) data = JSON.parse(saved); else resetDataStructure();
        render(); updateClock(); setInterval(updateClock, 1000);
    }

    function resetDataStructure() {
        data = {};
        let keys = [...configs.lous.order, ...configs.sandy.order];
        keys.forEach(k => data[k] = []);
    }

    function updateClock() {
        const now = new Date();
        let h = now.getHours(), m = now.getMinutes(), am = h >= 12 ? 'Ù…' : 'Øµ';
        h = h % 12 || 12; m = m < 10 ? '0' + m : m;
        document.getElementById('clock').innerText = `${h}:${m} ${am}`;
        let opt = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' };
        document.getElementById('full-date').innerText = now.toLocaleDateString('ar-SA', opt);
    }

    function validateAndAutoInput(el) {
        el.value = el.value.replace(/[^0-9]/g, '');
        let limit = document.getElementById('digitMode').checked ? 4 : 3;
        if (el.value.length >= limit) {
            let code = "\u202D" + activeLetter + "-" + el.value.substring(0, limit) + "\u202C";
            distribute(code); el.value = '';
        }
    }

    function distribute(code) {
        if (Object.values(data).flat().includes(code)) return;
        let config = configs[currentZone];
        let isSingle = document.getElementById('singleMode').checked;
        
        let target = config.main.slice(0, 2).find(u => data[u.n].length < 1);
        if (!target) {
            let fieldUnits = config.main.slice(2);
            target = isSingle ? fieldUnits.find(u => data[u.n].length === 0) : fieldUnits.find(u => data[u.n].length < u.c);
        }
        if (!target) {
            let mins = Math.min(...config.breakOrder.map(n => data[n].length));
            let name = config.breakOrder.find(n => data[n].length === mins);
            target = {n: name};
        }
        data[target.n].push(code);
        render(); save();
    }

    function render() {
        const build = (n) => `<div class="card"><div class="card-header">${n}</div><div class="card-body">
            ${data[n] ? data[n].map((c, i) => `<div class="tag">${c}<div class="tag-menu">
                <div onclick="move('${n}','ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',${i})">â¡ï¸ Ø®Ø±ÙˆØ¬</div>
                <div onclick="del('${n}',${i})">âŒ Ø­Ø°Ù</div>
            </div></div>`).join('') : ''}
        </div></div>`;
        
        document.getElementById('mainGrid').innerHTML = configs[currentZone].main.map(u => build(u.n)).join('');
        document.getElementById('leadGrid').innerHTML = ["Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ù†Ù‚Ø§Ø°", "Ø¯Ø¹Ù…"].map(build).join('');
        document.getElementById('exitGrid').innerHTML = build("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
    }

    function generateReport() {
        const now = new Date();
        const timeStr = document.getElementById('clock').innerText;
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
        let r = `ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø±ÙŠØ± Ø¹Ù…Ù„ÙŠØ§Øª ( ${currentZone==='lous'?'Ù„ÙˆØ³ Ø³Ø§Ù†ØªÙˆØ³':'Ø³Ø§Ù†Ø¯ÙŠ ÙˆØ¨ÙˆÙ„ÙŠØªÙˆ'} ) Ø±Ù‚Ù… ( ${reportNum} ) ÙÙŠ ØªÙ…Ø§Ù… Ø§Ù„Ø³Ø§Ø¹Ù‡ ( ${timeStr} ) Ø§Ù„ØªØ§Ø±ÙŠØ® ${dateStr}\n\n`;

        configs[currentZone].order.forEach(key => {
            let codes = (data[key] && data[key].length) ? data[key].join('\n') : "\u202D" + activeLetter + "-000\u202C";
            r += `\u200F${key} :\n${codes}\n\n`;
        });
        return r;
    }

    function openPreview() { document.getElementById('reportText').innerText = generateReport(); document.getElementById('reportModal').style.display = 'block'; }
    function copyDirect() { navigator.clipboard.writeText(generateReport()).then(() => alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®: ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ù…Ù‰ Ø¥Ù„Ù‰ 'Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…'")); }
    function copyFromModal() { copyDirect(); closeModal(); }
    function closeModal() { document.getElementById('reportModal').style.display = 'none'; }
    function save() { localStorage.setItem('ems_v11_data', JSON.stringify(data)); }
    function restoreData() { let b = localStorage.getItem('ems_v11_data'); if(b){ data=JSON.parse(b); render(); alert("âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©"); } }
    function del(n, i) { data[n].splice(i, 1); render(); save(); }
    function move(f, t, i) { data[t].push(data[f].splice(i, 1)[0]); render(); save(); }
    function setZone(z) { currentZone = z; document.querySelectorAll('#z-lous, #z-sandy').forEach(b => b.classList.toggle('active', b.id === 'z-'+z)); render(); }
    function selLet(l) { activeLetter = l; document.querySelectorAll('.let-btn').forEach(b => b.classList.toggle('active', b.innerText === l)); }
    function updatePlaceholder() { document.getElementById('mainInput').placeholder = document.getElementById('digitMode').checked ? "0000" : "000"; }
    function changeReportNum() { let n = prompt("Ø±Ù‚Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±:", reportNum); if(n){ reportNum=n; document.getElementById('reportDisplay').innerText=n; localStorage.setItem('ems_rep_num', n); } }
    function resetAll() { if(confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ")){ resetDataStructure(); render(); save(); } }
    function manualAdd(t) { let n = prompt("Ø§Ù„ÙƒÙˆØ¯:"); if(n){ data[t].push("\u202D" + activeLetter + "-" + n + "\u202C"); render(); save(); } }
    function rescheduleField() {
        let codes = [];
        configs[currentZone].main.slice(2).forEach(u => { codes = codes.concat(data[u.n]); data[u.n] = []; });
        codes.sort(() => Math.random() - 0.5).forEach(c => distribute(c));
    }
    init();
</script>
</body>
</html>
