<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>EMS System - Professional Version</title>
    <style>
        :root { --red: #b32633; --blue: #0056b3; --gold: #ffd700; --purple: #6a1b9a; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0a0a0a; color: white; margin: 0; padding: 15px; padding-bottom: 100px; }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 15px; font-size: 1.2rem; cursor: pointer; background: #222; border: 2px solid #444; color: white; border-radius: 8px; font-weight: bold; }
        .mode-btn.active.ls { background: var(--red); border-color: white; }
        .mode-btn.active.sb { background: var(--blue); border-color: white; }
        
        .control-panel { background: rgba(30, 30, 30, 0.9); padding: 20px; border-radius: 12px; border: 1px solid #444; margin-bottom: 20px; text-align: center; }
        .main-input { font-size: 40px; width: 180px; text-align: center; background: #000; color: var(--gold); border: 2px solid #555; border-radius: 10px; margin: 10px; padding: 5px; }
        
        .letter-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 15px; }
        .let-btn { width: 45px; height: 45px; background: #333; color: white; border: 1px solid #555; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .let-btn.active { background: var(--gold); color: black; border-color: white; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .card { background: #151515; border-radius: 8px; border: 1px solid #333; overflow: hidden; min-height: 100px; }
        .card-header { padding: 8px; text-align: center; font-weight: bold; font-size: 0.9rem; background: #222; border-bottom: 1px solid #333; }
        .ls-h { background: var(--red); }
        .sb-h { background: var(--blue); }
        .adm-h { background: var(--purple); }
        .ext-h { background: #444; }

        .card-body { padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
        .unit-tag { background: #000; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 14px; cursor: pointer; position: relative; }
        .unit-tag:hover { border-color: var(--gold); }
        .menu { display: none; position: absolute; top: 100%; left: 0; background: #222; border: 1px solid var(--gold); z-index: 10; width: 100px; }
        .unit-tag:hover .menu { display: block; }
        .menu div { padding: 8px; font-size: 12px; border-bottom: 1px solid #333; }
        .menu div:hover { background: #444; }

        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #111; padding: 15px; display: flex; justify-content: center; gap: 20px; border-top: 2px solid #444; }
        .copy-btn { padding: 10px 50px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="mode-selector">
        <button id="lsTab" class="mode-btn active ls" onclick="setMode('LS')">Ù„ÙˆØ³ Ø³Ø§Ù†ØªÙˆØ³</button>
        <button id="sbTab" class="mode-btn sb" onclick="setMode('SB')">Ø³Ø§Ù†Ø¯ÙŠ ÙˆØ¨ÙˆÙ„ÙŠØªÙˆ</button>
    </div>

    <div class="control-panel">
        <div class="letter-row" id="letterContainer"></div>
        <input type="text" id="codeIn" class="main-input" placeholder="000" maxlength="4">
        <br>
        <button class="mode-btn" style="width: 200px; font-size: 0.9rem; padding: 10px;" onclick="rebalance()">ğŸ”„ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…ÙŠØ¯Ø§Ù† (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)</button>
        <button class="mode-btn" style="width: 100px; font-size: 0.9rem; padding: 10px; background: #600;" onclick="resetAll()">âš ï¸ ØªØµÙÙŠØ±</button>
    </div>

    <div class="grid" id="mainGrid"></div>
    <div class="grid" id="adminGrid" style="margin-top: 20px;"></div>
    <div class="grid" id="exitGrid" style="margin-top: 20px;"></div>

    <div class="action-bar">
        <button class="copy-btn" onclick="copyReport()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>

<script>
    let mode = 'LS';
    let selectedLetter = 'E';
    const letters = ['E','A','F','M','S','C','G','P','H'];
    
    let data = {
        LS: { "Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©":[], "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…":[], "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ":[], "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª":[], "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª":[], "Ù„Ø§Ù… 1":[], "Ù„Ø§Ù… 2":[], "Ù„Ø§Ù… 3":[], "Ù„Ø§Ù… 4":[], "Ù„Ø§Ù… 5":[], "ÙØ±Ø³Ø§Ù†":[], "Ø¯Ø¹Ù…":[], "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡":[], "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°":[], "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬":[] },
        SB: { "Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©":[], "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…":[], "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ":[], "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª":[], "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª":[], "Ø³ÙŠÙ† 1":[], "Ø³ÙŠÙ†":[], "Ø¨Ø§Ø¡ 1":[], "Ø¨Ø§Ø¡":[], "Ø¬ÙŠÙ… 1":[], "Ø¬ÙŠÙ… 2":[], "Ø¯Ø¹Ù…":[], "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡":[], "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°":[], "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬":[] }
    };

    // Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ (Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨)
    const priorityLS = ["Ù„Ø§Ù… 2", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 1", "ÙØ±Ø³Ø§Ù†", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 1", "Ù„Ø§Ù… 5"];
    const prioritySB = ["Ø³ÙŠÙ† 1", "Ø¨Ø§Ø¡ 1", "Ø³ÙŠÙ†", "Ø¬ÙŠÙ… 1", "Ø¨Ø§Ø¡", "Ø³ÙŠÙ† 1", "Ø¨Ø§Ø¡ 1", "Ø³ÙŠÙ†", "Ø¬ÙŠÙ… 1", "Ø¨Ø§Ø¡", "Ø³ÙŠÙ† 1", "Ø¨Ø§Ø¡ 1", "Ø³ÙŠÙ†", "Ø¬ÙŠÙ… 1", "Ø³ÙŠÙ† 1", "Ø³ÙŠÙ†", "Ø¨Ø§Ø¡", "Ø¨Ø§Ø¡", "Ø¬ÙŠÙ… 2", "Ø¬ÙŠÙ… 2", "Ø¬ÙŠÙ… 2"];

    function setMode(m) {
        mode = m;
        document.getElementById('lsTab').className = 'mode-btn ' + (m==='LS'?'active ls':'');
        document.getElementById('sbTab').className = 'mode-btn ' + (m==='SB'?'active sb':'');
        render();
    }

    function initLetters() {
        const container = document.getElementById('letterContainer');
        container.innerHTML = letters.map(l => `<button class="let-btn ${l===selectedLetter?'active':''}" onclick="selectedLetter='${l}'; initLetters()">${l}</button>`).join('');
    }

    document.getElementById('codeIn').addEventListener('input', function(e) {
        let val = e.target.value.replace(/[^0-9]/g, '');
        if (val.length >= (['M','F','A','S'].includes(selectedLetter)? 2 : 3)) {
            addUnit(selectedLetter + "-" + val);
            e.target.value = '';
        }
    });

    function addUnit(code) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
        for(let k in data[mode]) if(data[mode][k].includes(code)) { alert("Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!"); return; }
        
        let d = data[mode];
        if (d["Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª"].length === 0) d["Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª"].push(code);
        else if (d["Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª"].length === 0) d["Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª"].push(code);
        else {
            // Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ Ø£ÙˆÙ„ Ø®Ø§Ù†Ø© Ø«Ù… Ù†Ø¶ØºØ· ØªÙ†Ø¸ÙŠÙ…
            let firstField = mode === 'LS' ? "Ù„Ø§Ù… 2" : "Ø³ÙŠÙ† 1";
            d[firstField].push(code);
            rebalance();
        }
        render();
    }

    function rebalance() {
        let d = data[mode];
        let fieldKeys = mode === 'LS' ? ["Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 5", "ÙØ±Ø³Ø§Ù†"] : ["Ø³ÙŠÙ† 1", "Ø³ÙŠÙ†", "Ø¨Ø§Ø¡ 1", "Ø¨Ø§Ø¡", "Ø¬ÙŠÙ… 1", "Ø¬ÙŠÙ… 2"];
        let pList = mode === 'LS' ? priorityLS : prioritySB;

        let pool = [];
        fieldKeys.forEach(k => { pool.push(...d[k]); d[k] = []; });

        pool.forEach((code, i) => {
            let target = pList[i] || pList[pList.length - 1];
            d[target].push(code);
        });
        render();
    }

    function moveUnit(from, index, to) {
        let unit = data[mode][from].splice(index, 1)[0];
        data[mode][to].push(unit);
        if(!["Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©","Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…","Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ"].includes(from)) rebalance();
        render();
    }

    function deleteUnit(from, index) {
        data[mode][from].splice(index, 1);
        rebalance();
        render();
    }

    function render() {
        const main = document.getElementById('mainGrid');
        const admin = document.getElementById('adminGrid');
        const exit = document.getElementById('exitGrid');
        main.innerHTML = ''; admin.innerHTML = ''; exit.innerHTML = '';

        const fieldOrder = mode === 'LS' ? ["Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 5", "ÙØ±Ø³Ø§Ù†"] : ["Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ø³ÙŠÙ† 1", "Ø³ÙŠÙ†", "Ø¨Ø§Ø¡ 1", "Ø¨Ø§Ø¡", "Ø¬ÙŠÙ… 1", "Ø¬ÙŠÙ… 2"];
        const adminOrder = ["Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ", "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "Ø¯Ø¹Ù…"];

        const createCard = (k, type) => {
            let hClass = type === 'field' ? (mode === 'LS' ? 'ls-h' : 'sb-h') : (type === 'admin' ? 'adm-h' : 'ext-h');
            let tags = data[mode][k].map((u, i) => `
                <div class="unit-tag">${u}
                    <div class="menu">
                        <div onclick="moveUnit('${k}', ${i}, 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬')">â¡ï¸ Ø®Ø±ÙˆØ¬</div>
                        <div onclick="deleteUnit('${k}', ${i})">âŒ Ø­Ø°Ù</div>
                    </div>
                </div>`).join('');
            
            return `<div class="card"><div class="card-header ${hClass}">${k}</div><div class="card-body">${tags}</div></div>`;
        };

        fieldOrder.forEach(k => main.innerHTML += createCard(k, 'field'));
        adminOrder.forEach(k => admin.innerHTML += createCard(k, 'admin'));
        exit.innerHTML += createCard("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", 'exit');
        
        localStorage.setItem('ems_save_v3', JSON.stringify(data));
    }

    function copyReport() {
        let d = data[mode];
        const now = new Date();
        let timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }).replace('AM','Øµ').replace('PM','Ù…');
        let dateStr = now.toLocaleDateString('ar-EG');
        
        let report = `ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø±ÙŠØ± Ø¹Ù…Ù„ÙŠØ§Øª ( ${mode==='LS'?'Ù„ÙˆØ³ Ø³Ø§Ù†ØªÙˆØ³':'Ø³Ø§Ù†Ø¯ÙŠ ÙˆØ¨ÙˆÙ„ÙŠØªÙˆ'} ) ÙÙŠ ØªÙ…Ø§Ù… Ø§Ù„Ø³Ø§Ø¹Ø© ( ${timeStr} ) Ø§Ù„ØªØ§Ø±ÙŠØ® ${dateStr}\n\n`;
        
        const fullOrder = mode === 'LS' ? 
            ["Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ", "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù„Ø§Ù… 1", "Ù„Ø§Ù… 2", "Ù„Ø§Ù… 3", "Ù„Ø§Ù… 4", "Ù„Ø§Ù… 5", "ÙØ±Ø³Ø§Ù†", "Ø¯Ø¹Ù…", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°", "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"] :
            ["Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©", "Ø§Ø´Ø±Ø§Ù Ø¹Ø§Ù…", "Ù…Ø´Ø±Ù Ù…ÙŠØ¯Ø§Ù†ÙŠ", "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù†Ø§Ø¦Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ø³ÙŠÙ† 1", "Ø³ÙŠÙ†", "Ø¨Ø§Ø¡ 1", "Ø¨Ø§Ø¡", "Ø¬ÙŠÙ… 1", "Ø¬ÙŠÙ… 2", "Ø¯Ø¹Ù…", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø§Ø°", "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"];

        fullOrder.forEach(k => {
            let units = d[k].length > 0 ? (k.includes("Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª") ? d[k].join(" | ") : d[k].join("\n")) : "E-000";
            report += `${k} :\n${units}\n\n`;
        });

        navigator.clipboard.writeText(report);
        alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
    }

    function resetAll() { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) { localStorage.clear(); location.reload(); } }

    window.onload = () => {
        let saved = localStorage.getItem('ems_save_v3');
        if(saved) data = JSON.parse(saved);
        initLetters();
        render();
    };
</script>
</body>
</html>
